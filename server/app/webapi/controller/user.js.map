{
    "version": 3,
    "sources": [
        "../../../src/webapi/controller/user.js"
    ],
    "names": [
        "axios",
        "require",
        "conf",
        "jwt",
        "init",
        "http",
        "_isRest",
        "__before",
        "modelInstance",
        "fieldReverse",
        "infoAction",
        "auth",
        "think",
        "service",
        "userId",
        "getUserId",
        "header",
        "find",
        "u_id",
        "data",
        "success",
        "fail",
        "loginAction",
        "post",
        "code",
        "nickName",
        "avatarUrl",
        "url",
        "appId",
        "appSecret",
        "get",
        "res",
        "openid",
        "session_key",
        "thenAdd",
        "name",
        "image_url",
        "open_id",
        "insertId",
        "token",
        "sign",
        "id",
        "jwtSecret",
        "expiresIn",
        "controller",
        "rest"
    ],
    "mappings": "AAAA;;;;;;;;;;;;;;;;;;;;;;;;;;AAEA,IAAMA,QAAQC,QAAQ,OAAR,CAAd;AACA,IAAMC,OAAOD,QAAQ,oBAAR,CAAb;AACA,IAAME,MAAMF,QAAQ,cAAR,CAAZ;;AAEA;;;;;;;;;;;;;AAKE;;;;;mBAKAG,I,iBAAKC,I,EAAK;AACR,oCAAMD,IAAN,YAAWC,IAAX;AACA,SAAKC,OAAL,GAAe,KAAf;AACD,G;;AAED;;;;;;mBAIAC,Q,uBAAU;AACR,SAAKC,aAAL,CAAmBC,YAAnB,CAAgC,8BAAhC;AACD,G;;AAED;;;mBACMC,U;;;;;;;AACAC,kB,GAAOC,MAAMC,OAAN,CAAc,MAAd,C;AACPC,oB,GAASH,KAAKI,SAAL,CAAe,KAAKC,MAAL,CAAY,OAAZ,CAAf,C;;mBACVF,M;;;;;;qBACgB,KAAKN,aAAL,CAAmBS,IAAnB,CAAwB,EAACC,MAAKJ,MAAN,EAAxB,C;;;AAAbK,kB;+CACG,KAAKC,OAAL,CAAaD,IAAb,C;;;+CAEA,KAAKE,IAAL,CAAU,SAAV,C;;;;;;;;;;;;;;;;;AAIX;;;mBACMC,W;;;;;;;;sBACgC,KAAKC,IAAL,E,EAA9BC,I,SAAAA,I,EAAMC,Q,SAAAA,Q,EAAUC,S,SAAAA,S;AAChBC,iB,GAAM,wDACVzB,KAAK0B,KADK,GACG,UADH,GACgB1B,KAAK2B,SADrB,GACiC,WADjC,GAC+CL,IAD/C,GACsD,gC;;qBAChDxB,MAAM8B,GAAN,CAAUH,GAAV,C;;;AAAZI,iB;0BAC0BA,IAAIZ,I,EAA5Ba,M,aAAAA,M,EAAQC,W,aAAAA,W;;kBACXD,M;;;;;gDACI,KAAKX,IAAL,CAAU,QAAV,C;;;;qBAEY,KAAKb,aAAL,CAAmB0B,OAAnB,CAA2B,EAACC,MAAMV,QAAP,EAAiBW,WAAWV,SAA5B,EAAuCW,SAASL,MAAhD,EAAwDC,aAAaA,WAArE,EAA3B,EAA6G,EAACI,SAASL,MAAV,EAA7G,C;;;AAAjBM,sB;AACEC,mB,GAAQpC,IAAIqC,IAAJ,CAAS,EAAEC,IAAIH,SAASpB,IAAf,EAAT,EAAgChB,KAAKwC,SAArC,EAAgD,EAAEC,WAAW,IAAb,EAAhD,C;gDACP,KAAKvB,OAAL,CAAa,EAACmB,YAAD,EAAb,C;;;;;;;;;;;;;;;;;;EA3CkB3B,MAAMgC,UAAN,CAAiBC,I",
    "file": "../../../src/webapi/controller/user.js",
    "sourcesContent": [
        "'use strict';\n\nconst axios = require('axios')\nconst conf = require('../../../config.js')\nconst jwt = require('jsonwebtoken')\n\n/**\n * rest controller\n * @type {Class}\n */\nexport default class extends think.controller.rest {\n  /**\n   * init\n   * @param  {Object} http []\n   * @return {}      []\n   */\n  init(http){\n    super.init(http);\n    this._isRest = false;\n  }\n  \n  /**\n   * before magic method\n   * @return {Promise} []\n   */\n  __before(){\n    this.modelInstance.fieldReverse('password,open_id,session_key');\n  }\n\n  //获取用户信息\n  async infoAction(){\n    let auth = think.service('auth'); \n    let userId = auth.getUserId(this.header('token'))\n    if(userId){\n      let data = await this.modelInstance.find({u_id:userId});\n      return this.success(data);\n    }else{\n      return this.fail('token无效');\n    }\n  }\n\n  //添加用户\n  async loginAction(){\n    let { code, nickName, avatarUrl } = this.post();\n    const url = 'https://api.weixin.qq.com/sns/jscode2session?appid=' +\n      conf.appId + '&secret=' + conf.appSecret + '&js_code=' + code + '&grant_type=authorization_code'\n    const res = await axios.get(url)\n    const { openid, session_key } = res.data\n    if (!openid){\n      return this.fail('code无效');\n    }\n    let insertId = await this.modelInstance.thenAdd({name: nickName, image_url: avatarUrl, open_id: openid, session_key: session_key},{open_id: openid});\n    const token = jwt.sign({ id: insertId.u_id }, conf.jwtSecret, { expiresIn: '7d' })\n    return this.success({token});\n  }\n\n}"
    ]
}