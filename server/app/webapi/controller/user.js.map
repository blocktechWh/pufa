{
    "version": 3,
    "sources": [
        "../../../src/webapi/controller/user.js"
    ],
    "names": [
        "axios",
        "require",
        "conf",
        "jwt",
        "init",
        "http",
        "_isRest",
        "__before",
        "modelInstance",
        "fieldReverse",
        "infoAction",
        "userId",
        "think",
        "service",
        "getUserId",
        "find",
        "u_id",
        "data",
        "success",
        "loginAction",
        "post",
        "code",
        "nickName",
        "avatarUrl",
        "url",
        "appId",
        "appSecret",
        "get",
        "res",
        "openid",
        "session_key",
        "fail",
        "thenAdd",
        "name",
        "image_url",
        "open_id",
        "insertId",
        "token",
        "sign",
        "id",
        "jwtSecret",
        "expiresIn",
        "controller",
        "rest"
    ],
    "mappings": "AAAA;;;;;;;;;;;;;;;;;;;;;;;;;;AAEA,IAAMA,QAAQC,QAAQ,OAAR,CAAd;AACA,IAAMC,OAAOD,QAAQ,oBAAR,CAAb;AACA,IAAME,MAAMF,QAAQ,cAAR,CAAZ;;;;;;;;;;mBAIEG,I,iBAAKC,I,EAAK;AACR,oCAAMD,IAAN,YAAWC,IAAX;AACA,SAAKC,OAAL,GAAe,KAAf;AACD,G;;mBAEDC,Q,uBAAU;AACR,SAAKC,aAAL,CAAmBC,YAAnB,CAAgC,8BAAhC;AACD,G;;AAED;;;mBACMC,U;;;;;;;AACAC,oB,GAASC,MAAMC,OAAN,CAAc,MAAd,EAAsBC,SAAtB,CAAgC,IAAhC,C;;kBACTH,M;;;;;;;;;qBACa,KAAKH,aAAL,CAAmBO,IAAnB,CAAwB,EAACC,MAAKL,MAAN,EAAxB,C;;;AAAbM,kB;+CACG,KAAKC,OAAL,CAAaD,IAAb,C;;;;;;;;;;;;;;;;;AAGT;;;mBACME,W;;;;;;;;sBACgC,KAAKC,IAAL,E,EAA9BC,I,SAAAA,I,EAAMC,Q,SAAAA,Q,EAAUC,S,SAAAA,S;AAChBC,iB,GAAM,wDACVtB,KAAKuB,KADK,GACG,UADH,GACgBvB,KAAKwB,SADrB,GACiC,WADjC,GAC+CL,IAD/C,GACsD,gC;;qBAChDrB,MAAM2B,GAAN,CAAUH,GAAV,C;;;AAAZI,iB;0BAC0BA,IAAIX,I,EAA5BY,M,aAAAA,M,EAAQC,W,aAAAA,W;;kBACXD,M;;;;;gDACI,KAAKE,IAAL,CAAU,QAAV,C;;;;qBAEY,KAAKvB,aAAL,CAAmBwB,OAAnB,CAA2B,EAACC,MAAMX,QAAP,EAAiBY,WAAWX,SAA5B,EAAuCY,SAASN,MAAhD,EAAwDC,aAAaA,WAArE,EAA3B,EAA6G,EAACK,SAASN,MAAV,EAA7G,C;;;AAAjBO,sB;AACEC,mB,GAAQlC,IAAImC,IAAJ,CAAS,EAAEC,IAAIH,SAASpB,IAAf,EAAT,EAAgCd,KAAKsC,SAArC,EAAgD,EAAEC,WAAW,IAAb,EAAhD,C;gDACP,KAAKvB,OAAL,CAAa,EAACmB,YAAD,EAAb,C;;;;;;;;;;;;;;;;;;EA/BkBzB,MAAM8B,UAAN,CAAiBC,I",
    "file": "../../../src/webapi/controller/user.js",
    "sourcesContent": [
        "'use strict';\n\nconst axios = require('axios')\nconst conf = require('../../../config.js')\nconst jwt = require('jsonwebtoken')\n\nexport default class extends think.controller.rest {\n  \n  init(http){\n    super.init(http);\n    this._isRest = false;\n  }\n  \n  __before(){\n    this.modelInstance.fieldReverse('password,open_id,session_key');\n  }\n\n  //获取用户信息\n  async infoAction(){\n    let userId = think.service('auth').getUserId(this)\n    if(!userId)return;\n    let data = await this.modelInstance.find({u_id:userId});\n    return this.success(data);\n  }\n\n  //添加用户\n  async loginAction(){\n    let { code, nickName, avatarUrl } = this.post();\n    const url = 'https://api.weixin.qq.com/sns/jscode2session?appid=' +\n      conf.appId + '&secret=' + conf.appSecret + '&js_code=' + code + '&grant_type=authorization_code'\n    const res = await axios.get(url)\n    const { openid, session_key } = res.data\n    if (!openid){\n      return this.fail('code无效');\n    }\n    let insertId = await this.modelInstance.thenAdd({name: nickName, image_url: avatarUrl, open_id: openid, session_key: session_key},{open_id: openid});\n    const token = jwt.sign({ id: insertId.u_id }, conf.jwtSecret, { expiresIn: '7d' })\n    return this.success({token});\n  }\n\n}"
    ]
}